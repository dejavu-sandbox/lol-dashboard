<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Chaudron : LoL Ranked Dashboard</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- RESET GLOBAL CRUCIAL --- */
        * {
            box-sizing: border-box; /* Emp√™che le padding de casser les largeurs */
        }

        /* --- GENERAL --- */
        body {
            background-color: #091428;
            color: #f0e6d2;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #c8aa6e;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
            border-bottom: 2px solid #c8aa6e;
            display: inline-block;
            padding-bottom: 10px;
        }

        /* --- CONTENEUR UNIQUE ET PROPRE --- */
        /* S'applique aux DEUX tableaux pour garantir l'alignement */
        .main-box {
            width: 1450px;          /* Largeur fixe unifi√©e */
            max-width: 95vw;        /* S√©curit√© responsive */
            margin: 40px auto;      /* Centrage horizontal parfait */
            background-color: #0a0a0c;
            border: 2px solid #c8aa6e;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: block;
            overflow: hidden;       /* Garde les coins arrondis propres */
        }

        /* Padding sp√©cifique pour le 2√®me tableau qui contient des grilles */
        #visualStats {
            padding: 25px;
        }

        /* --- TABLEAU PRINCIPAL --- */
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: transparent;
            border: none;
            table-layout: fixed; /* Force le respect des largeurs */
        }

        th {
            background-color: #1e2328;
            color: #c8aa6e;
            padding: 15px;
            text-transform: uppercase;
            font-size: 0.8em;
            border-bottom: 2px solid #c8aa6e;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #333;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Largeurs fixes pour alignement */
        table th:nth-child(1), table td:nth-child(1) { width: 280px; text-align: left; padding-left: 20px; } /* Player */
        table th:nth-child(2), table td:nth-child(2) { width: 180px; } /* Rank */
        table th:nth-child(3), table td:nth-child(3) { width: 100px; } /* Streak */
        table th:nth-child(4), table td:nth-child(4) { width: 100px; } /* WR Season */
        table th:nth-child(5), table td:nth-child(5) { width: 100px; } /* WR Last 20 */
        table th:nth-child(6), table td:nth-child(6) { width: 140px; } /* KDA */
        table th:nth-child(7), table td:nth-child(7) { width: 100px; } /* Toxicity */
        table th:nth-child(8), table td:nth-child(8) { width: 100px; } /* Trend */
        table th:nth-child(9), table td:nth-child(9) { width: 200px; } /* Badge */

        tr.player-row:hover {
            background-color: #1e282d;
            cursor: pointer;
            transition: 0.1s;
            filter: brightness(1.1);
        }

        /* --- VISUAL STATS (TITRE & GRILLE) --- */
        .visual-stats-title {
            color: #c8aa6e;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0 0 30px 0;
            font-size: 1.5em;
            text-align: center;
        }

        .player-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 colonnes strictes */
            gap: 20px;
            align-items: stretch;
        }

        .player-card {
            background: #151a21;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .player-card-header {
            color: #c8aa6e;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* --- GRAPHIQUES --- */
        .charts-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex: 1; /* Prend l'espace disponible verticalement */
            align-items: flex-start;
        }

        .chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .chart-title {
            color: #a09b8c;
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pie-wrapper {
            position: relative;
            height: 140px;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .pie-wrapper canvas {
            max-height: 100% !important;
            max-width: 100% !important;
        }

        /* L√©gende personnalis√©e align√©e */
        .custom-legend {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align√© gauche */
            gap: 4px;
            width: 100%;
            padding: 0 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            color: #a09b8c;
            white-space: nowrap;
            width: 100%;
        }

        .legend-color, .legend-icon {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .legend-icon { border: 1px solid #444; }

        /* --- PING RECORD (ALIGNEMENT BAS) --- */
        .personal-worst {
            background: linear-gradient(90deg, rgba(255, 88, 89, 0.1) 0%, rgba(21, 26, 33, 0) 100%);
            border-left: 3px solid #ff5859;
            padding: 15px;
            border-radius: 5px;
            margin-top: auto; /* Pousse ce bloc tout en bas */
            cursor: pointer;
            transition: background 0.2s;
        }

        .personal-worst:hover {
            background: linear-gradient(90deg, rgba(255, 88, 89, 0.15) 0%, rgba(21, 26, 33, 0) 100%);
        }

        .personal-worst-title {
            color: #ff5859;
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .personal-worst-content {
            color: #f0e6d2;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .ping-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .ping-item {
            background: #0a0a0c;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8em;
        }

        .ping-count { color: #ff8c00; font-weight: bold; }

        /* --- STYLES DIVERS --- */
        .win-high { color: #2deb90; font-weight: bold; }
        .win-low { color: #ff5859; font-weight: bold; }
        .win-mid { color: #f0e6d2; font-weight: bold; }
        .streak-win { color: #ff8c00; font-weight: bold; text-shadow: 0 0 8px rgba(255, 140, 0, 0.4); text-transform: uppercase; font-size: 0.9em; }
        .streak-loss { color: #ff5859; font-weight: bold; text-transform: uppercase; font-size: 0.9em; opacity: 0.8; }
        .toxic-ping { color: #ff5859; font-weight: bold; }

        /* Player Info */
        .player-cell { display: flex; align-items: center; }
        .profile-icon { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #c8aa6e; margin-right: 15px; flex-shrink: 0; }
        .player-info { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; gap: 4px; overflow: hidden; }
        .name-tag-row { display: flex; align-items: center; gap: 6px; width: 100%; }
        .player-name { font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag { font-size: 0.8em; color: #666; font-weight: normal; margin: 0; flex-shrink: 0; }
        .main-champ-icon { width: 22px; height: 22px; border-radius: 3px; border: 1px solid #444; box-shadow: 0 0 4px rgba(0, 0, 0, 0.5); flex-shrink: 0; }
        .sub-stat { font-size: 0.7em; color: #888; margin-top: 4px; font-weight: normal; }

        /* Rank */
        .rank-container { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .rank-icon { width: 40px; height: 40px; object-fit: contain; }
        .rank-text { font-size: 0.9em; color: #a09b8c; text-align: center; line-height: 1.2; }

        /* Badges */
        .badges-flex { display: flex; align-items: center; justify-content: center; gap: 6px; height: 100%; flex-wrap: nowrap; }
        .badge-icon { width: 40px; height: 40px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); transition: transform 0.2s; cursor: help; flex-shrink: 0; }
        .badge-icon:hover { transform: scale(1.2); z-index: 10; }
        /* Bordures Badges */
        .badge-toxic { border: 1px solid #ff5859; }
        .badge-fire { border: 1px solid #ff8c00; }
        .badge-sad { border: 1px solid #888; }
        .badge-feed { border: 1px solid #a020f0; }
        .badge-otp { border: 1px solid #8a2be2; box-shadow: 0 0 8px rgba(138, 43, 226, 0.4); }
        .badge-versatile { border: 1px solid #00d9ff; }
        .badge-death_magnet { border: 1px solid #8b0000; }
        .badge-unkillable { border: 1px solid #2deb90; box-shadow: 0 0 6px rgba(45, 235, 144, 0.3); }
        .badge-carry { border: 1px solid #ff4444; box-shadow: 0 0 8px rgba(255, 68, 68, 0.4); }
        .badge-farmer { border: 1px solid #ffd700; }

        /* Refresh Button */
        .refresh-controls { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; padding: 0 5px; }
        .refresh-btn { background: linear-gradient(135deg, #1e2328 0%, #0a0a0c 100%); border: 2px solid #c8aa6e; color: #c8aa6e; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        .refresh-btn:hover:not(:disabled) { background: linear-gradient(135deg, #c8aa6e 0%, #a89968 100%); color: #0a0a0c; transform: translateY(-1px); }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .refresh-btn.loading #refreshIcon { animation: spin 1s linear infinite; }
        .last-updated { color: #888; font-size: 13px; font-style: italic; }

        /* Links */
        .external-links { display: flex; gap: 6px; margin-top: 3px; }
        .link-icon { font-size: 0.7em; text-decoration: none; padding: 2px 8px; border-radius: 4px; font-weight: bold; transition: 0.2s; display: inline-block; }
        .op-gg { background-color: #5383e8; color: white; }
        .deeplol { background-color: #1a1f29; color: #00d9ff; border: 1px solid #333; }
        .link-icon:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Loading */
        #loading { margin-top: 50px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #c8aa6e; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #0a0a0c; margin: 2% auto; padding: 20px; border: 2px solid #c8aa6e; width: 95%; max-width: 1000px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .match-history { list-style: none; padding: 0; margin-top: 20px; }
        .match-container { margin-bottom: 8px; border-radius: 5px; overflow: hidden; }
        
        .match-header, .match-row { display: grid; grid-template-columns: 2.8fr 0.5fr 0.9fr 1fr 1fr 1fr 1fr 1fr 1fr; align-items: center; padding: 12px; font-size: 0.9em; }
        .match-header { font-weight: bold; color: #c8aa6e; margin-bottom: 10px; text-transform: uppercase; font-size: 0.8em; border-bottom: 1px solid #333; }
        .match-row { background: #151a21; border-left: 5px solid #555; cursor: pointer; transition: background 0.2s; }
        .match-row:hover { background-color: #1f2731; transform: translateX(2px); }
        .match-win { border-left-color: #2deb90; background: linear-gradient(90deg, rgba(45, 235, 144, 0.1) 0%, rgba(21, 26, 33, 0) 100%); }
        .match-loss { border-left-color: #ff5859; background: linear-gradient(90deg, rgba(255, 88, 89, 0.1) 0%, rgba(21, 26, 33, 0) 100%); }
        
        .champ-flex { display: flex; align-items: center; gap: 10px; color: #fff; font-weight: bold; }
        .champ-icon { width: 36px; height: 36px; border-radius: 4px; border: 1px solid #444; }
        .vs-column { display: flex; align-items: center; justify-content: center; }
        .enemy-icon { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #333; transition: 0.2s; }
        .match-details { display: none; background-color: #0f1216; padding: 15px; border-top: 1px solid #333; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center; }
        .stat-box { background: #1c2129; padding: 10px; border-radius: 5px; }
        .stat-label { font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 1.1em; font-weight: bold; color: #f0e6d2; }
        .gold-text { color: #ffd700; }
        .dmg-text { color: #ff5859; }
        .heal-text { color: #2deb90; }
        .stat-detail { font-size: 0.85em; color: #aaa; }

        .lp-plus { color: #2deb90; font-weight: bold; }
        .lp-minus { color: #ff5859; font-weight: bold; }
        .lp-na { color: #444; font-style: italic; }

        .help-icon { display: inline-flex; justify-content: center; align-items: center; width: 16px; height: 16px; background-color: #555; color: #fff; border-radius: 50%; font-size: 11px; font-weight: bold; margin-left: 6px; cursor: help; position: relative; }
        .help-icon .tooltip-text { visibility: hidden; width: 210px; background-color: #121212; color: #e0e0e0; font-size: 12px; font-weight: 400; padding: 12px; position: absolute; z-index: 9999; bottom: 135%; left: 50%; transform: translateX(-50%); border: 1px solid #ffd700; opacity: 0; transition: all 0.2s ease-in-out; pointer-events: none; }
        .help-icon:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>

<body>

    <h1>üèÜ Le Chaudron : LoL Ranked Dashboard üèÜ</h1>

    <div id="loading">
        <div class="spinner"></div>
        <p style="color:#c8aa6e; letter-spacing:1px;">Summoning data from the Void...</p>
        <p style="color:#666; font-size:0.8em;">(Manual refresh may take ~30s, please wait!)</p>
    </div>

    <div class="main-box" id="dashboard">
        <div class="refresh-controls">
            <button id="refreshBtn" class="refresh-btn" onclick="manualRefresh()" disabled>
                <span id="refreshIcon">‚Üª</span>
                <span id="refreshText">Refresh</span>
            </button>
            <div class="last-updated">
                <span id="lastUpdatedText">Last updated: Never</span>
            </div>
        </div>
        <table id="statsTable">
            <thead>
                <tr>
                    <th style="text-align: left; padding-left: 40px;">Player</th>
                    <th>Rank</th>
                    <th>Streak</th>
                    <th>WR (Season)</th>
                    <th>WR (Last 20)</th>
                    <th>
                        <div style="display:flex; align-items:center; justify-content:center;">
                            KDA & Impact
                            <div class="help-icon">?
                                <span class="tooltip-text">
                                    Based on <strong>Last 20 Games</strong>.<br>
                                    <span style="color:#2deb90">KP</span> = Kill Participation.<br>
                                    <span style="color:#ff5859">Death%</span> = Share of team's deaths (Lower is better).
                                </span>
                            </div>
                        </div>
                    </th>
                    <th>
                        <div style="display:flex; align-items:center; justify-content:center;">
                            Toxicity
                            <div class="help-icon">?
                                <span class="tooltip-text">
                                    Average of <strong>"?"</strong> (Missing) and <strong>"Push Forward"</strong> pings per game.
                                </span>
                            </div>
                        </div>
                    </th>
                    <th>Trend</th>
                    <th>Badge</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="main-box" id="visualStats" style="display: none;">
        <h2 class="visual-stats-title">Visual Statistics - Last 20 Games</h2>
        <div class="player-stats-grid" id="playerStatsGrid">
            </div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="color:#c8aa6e; border-bottom:1px solid #333; padding-bottom:10px;">Details</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const apiUrl = "https://func-lol-tracker-backend-001-hefnbhgxfjhgf3bk.francecentral-01.azurewebsites.net/api/GetLoLStats";
        const CACHE_KEY = "lol_dashboard_cache";
        const CACHE_TIMESTAMP_KEY = "lol_dashboard_cache_timestamp";
        const API_REFRESH_TIMESTAMP_KEY = "lol_dashboard_api_refresh_timestamp";
        const MIN_REFRESH_INTERVAL = 60000;

        let ddragonVersion = "16.2.1";
        let lastRefreshTime = 0;
        let lastApiRefreshTime = 0;

        // --- UTILS ---
        function formatTimeAgo(timestamp) {
            if (!timestamp) return "Never";
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return "< 1m ago";
            return `${minutes}m ago`;
        }

        function updateLastUpdatedText() {
            const textElement = document.getElementById('lastUpdatedText');
            if (lastApiRefreshTime > 0) {
                textElement.textContent = `Last updated: ${formatTimeAgo(lastApiRefreshTime)}`;
            }
        }

        function loadCachedData() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
            const apiRefreshTimestamp = localStorage.getItem(API_REFRESH_TIMESTAMP_KEY);
            
            if (cachedData) {
                try {
                    const data = JSON.parse(cachedData);
                    displayData(data);
                    if (cachedTimestamp) lastRefreshTime = parseInt(cachedTimestamp);
                    if (apiRefreshTimestamp) {
                        lastApiRefreshTime = parseInt(apiRefreshTimestamp);
                        updateRefreshButton();
                    }
                    document.getElementById('loading').style.display = 'none';
                    return true;
                } catch (e) { console.error("Cache error", e); }
            }
            return false;
        }

        function updateRefreshButton() {
            const btn = document.getElementById('refreshBtn');
            const textSpan = document.getElementById('refreshText');
            const now = Date.now();
            const timeSinceApiRefresh = now - lastApiRefreshTime;
            
            updateLastUpdatedText();
            
            if (lastApiRefreshTime > 0 && timeSinceApiRefresh < MIN_REFRESH_INTERVAL) {
                const remainingSeconds = Math.ceil((MIN_REFRESH_INTERVAL - timeSinceApiRefresh) / 1000);
                btn.disabled = true;
                textSpan.textContent = `Wait ${remainingSeconds}s`;
                setTimeout(updateRefreshButton, 1000);
            } else {
                btn.disabled = false;
                textSpan.textContent = 'Refresh';
                setTimeout(updateRefreshButton, 10000);
            }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            btn.disabled = true;
            btn.classList.add('loading');
            
            await fetchStats(true);
            
            loading.style.display = 'none';
            btn.classList.remove('loading');
            updateRefreshButton();
        }

        async function fetchStats(isManualRefresh = false) {
            try {
                if (isManualRefresh) document.getElementById('loading').style.display = 'block';
                
                const vResponse = await fetch("https://ddragon.leagueoflegends.com/api/versions.json");
                const versions = await vResponse.json();
                ddragonVersion = versions[0];

                const url = isManualRefresh ? `${apiUrl}?refresh=true` : apiUrl;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Azure error");
                const responseData = await response.json();
                
                const data = responseData.Data || responseData;
                const backendLastUpdate = responseData.LastUpdate ? new Date(responseData.LastUpdate).getTime() : null;
                
                const now = Date.now();
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());
                lastRefreshTime = now;
                
                if (isManualRefresh) {
                    localStorage.setItem(API_REFRESH_TIMESTAMP_KEY, now.toString());
                    lastApiRefreshTime = now;
                } else if (backendLastUpdate) {
                    localStorage.setItem(API_REFRESH_TIMESTAMP_KEY, backendLastUpdate.toString());
                    lastApiRefreshTime = backendLastUpdate;
                }
                
                displayData(data);
                document.getElementById('loading').style.display = 'none';
                updateRefreshButton();
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = `<p style='color:red;'>Error: ${error.message}</p>`;
            }
        }

        window.onload = function() {
            const hasCachedData = loadCachedData();
            const now = Date.now();
            if (!hasCachedData || (now - lastRefreshTime >= MIN_REFRESH_INTERVAL)) {
                fetchStats(false);
            } else {
                updateRefreshButton();
            }
        };

        // --- DISPLAY LOGIC ---
        function displayData(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            const tbody = document.querySelector("#statsTable tbody");
            tbody.innerHTML = "";
            const players = Object.keys(data).map(key => ({ name: key, ...data[key] }));

            // Tri
            const tierValues = { "CHALLENGER": 90000, "GRANDMASTER": 80000, "MASTER": 70000, "DIAMOND": 60000, "EMERALD": 50000, "PLATINUM": 40000, "GOLD": 30000, "SILVER": 20000, "BRONZE": 10000, "IRON": 0, "UNRANKED": -10000 };
            const divValues = { "I": 1200, "II": 800, "III": 400, "IV": 0 };

            function getRankScore(rankStr) {
                if (!rankStr || rankStr === "Unranked") return -10000;
                let match = rankStr.toUpperCase().match(/^(\w+)(?:\s+([IVX]+))?\s+\((\d+)\s+LP\)/);
                if (!match) return 0;
                let tier = match[1]; let div = match[2] || ""; let lp = parseInt(match[3]);
                let score = (tierValues[tier] || 0);
                if (tier === "MASTER" || tier === "GRANDMASTER" || tier === "CHALLENGER") score += lp;
                else score += (divValues[div] || 0) + lp;
                return score;
            }
            players.sort((a, b) => getRankScore(b.Rank) - getRankScore(a.Rank));

            players.forEach(player => {
                const tr = document.createElement("tr");
                tr.classList.add("player-row");
                tr.onclick = function () { openModal(player); };

                // Trend
                const trend = player.DailyLp || "0 LP";
                let dailyHtml = trend.startsWith("+") ? `<span class="lp-plus">${trend}</span>` : 
                                trend.startsWith("-") ? `<span class="lp-minus">${trend}</span>` : 
                                `<span style="color:#888">0 LP</span>`;

                // Winrates
                let winClass = player.Winrate >= 50 ? "win-high" : "win-low";

                // Badges
                let badgesHtml = "";
                if (player.Badges && player.Badges.length > 0) {
                    player.Badges.forEach(badge => {
                        let imgSrc = "";
                        let extraClass = "";
                        let extraStyle = "";

                        if (badge.LocalIcon) imgSrc = badge.LocalIcon;
                        else if (badge.Spell) imgSrc = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/spell/${badge.Spell}.png`;
                        else if (badge.Icon) imgSrc = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/profileicon/${badge.Icon}.png`;
                        else if (badge.Champion) imgSrc = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/champion/${badge.Champion}.png`;

                        if (badge.Type === "toxic") extraClass = "badge-toxic";
                        else if (badge.Type === "fire") extraClass = "badge-fire";
                        else if (badge.Type === "sad") extraClass = "badge-sad";
                        else if (badge.Type === "feed") extraClass = "badge-feed";
                        else if (badge.Type === "otp") extraClass = "badge-otp";
                        else if (badge.Type === "versatile") extraClass = "badge-versatile";
                        else if (badge.Type === "death_magnet") extraClass = "badge-death_magnet";
                        else if (badge.Type === "unkillable") extraClass = "badge-unkillable";
                        else if (badge.Type === "carry") extraClass = "badge-carry";
                        else if (badge.Type === "farmer") extraClass = "badge-farmer";
                        else if (badge.Type === "smurf" || badge.Type === "penta") extraStyle = "border: 1px solid #ffd700;";
                        else if (badge.Type === "quadra") extraStyle = "border: 1px solid #ff4c4c;";

                        badgesHtml += `<img src="${imgSrc}" class="badge-icon ${extraClass}" style="${extraStyle}" title="${badge.Title}">`;
                    });
                }

                // Rank Display
                let displayRank = player.Rank.replace("MASTER I", "MASTER").replace("GRANDMASTER I", "GRANDMASTER").replace("CHALLENGER I", "CHALLENGER");
                let rankTier = "Unranked";
                const tierMatch = player.Rank.match(/^(\w+)/);
                if (tierMatch) rankTier = tierMatch[1].charAt(0).toUpperCase() + tierMatch[1].slice(1).toLowerCase();
                const rankIconUrl = `img/Rank=${rankTier}.png`;

                let pingClass = player.AvgPings > 6 ? "toxic-ping" : "";
                const iconUrl = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/profileicon/${player.ProfileIcon}.png`;

                let mainChampHtml = "";
                if (player.MainChamp) mainChampHtml = `<img src="https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/champion/${player.MainChamp}.png" class="main-champ-icon" title="Main: ${player.MainChamp}">`;

                let streakIcon = "-";
                if (player.StreakType === "Win" && player.StreakCount >= 1) streakIcon = `<span class="streak-win">üî• ${player.StreakCount} Wins</span>`;
                else if (player.StreakType === "Loss" && player.StreakCount >= 1) streakIcon = `<span class="streak-loss">üíÄ ${player.StreakCount} Loses</span>`;

                const urlName = `${player.name}-${player.Tag}`.replace(/\s+/g, '%20');
                const avgKpColor = player.AvgKP >= 50 ? '#2deb90' : '#aaa';
                const avgDeathColor = player.AvgDeathShare > 25 ? '#ff5859' : '#888';

                tr.innerHTML = `
                <td>
                    <div class="player-cell">
                        <img src="${iconUrl}" class="profile-icon">
                        <div class="player-info">
                            <div class="name-tag-row">
                                <span class="player-name" style="margin-left:5px;">${player.name}</span>
                                <span class="tag">#${player.Tag}</span>
                                ${mainChampHtml} 
                            </div>
                            <div class="external-links" onclick="event.stopPropagation()"> 
                                <a href="https://www.op.gg/summoners/euw/${urlName}" target="_blank" class="link-icon op-gg">OP</a>
                                <a href="https://www.deeplol.gg/summoner/euw/${urlName}" target="_blank" class="link-icon deeplol">DL</a>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="rank-container">
                        <img src="${rankIconUrl}" class="rank-icon" alt="${rankTier}">
                        <div class="rank-text">${displayRank}</div>
                    </div>
                </td>
                <td>${streakIcon}</td>
                <td class="win-mid">${player.GlobalWinrate || 0}%<br><span class="sub-stat">${player.GlobalGames || 0} games</span></td>
                <td class="${winClass}">${player.Winrate}%</td>
                <td>
                    ${player.AvgKDA || 0}
                    <div class="sub-stat">
                        <span style="color:${avgKpColor}">${player.AvgKP}% KP</span> | 
                        <span style="color:${avgDeathColor}">${player.AvgDeathShare}% Death</span>
                    </div>
                </td>
                <td class="${pingClass}">${player.AvgPings} pings</td>
                <td>${dailyHtml}</td>
                <td><div class="badges-flex">${badgesHtml}</div></td>
                `;
                tbody.appendChild(tr);
            });

            generateVisualStats(data);
        }

        // --- VISUAL STATS ---
        function generateVisualStats(data) {
            const visualStatsContainer = document.getElementById('visualStats');
            const playerStatsGrid = document.getElementById('playerStatsGrid');
            playerStatsGrid.innerHTML = "";
            
            const players = Object.keys(data).map(key => ({ name: key, ...data[key] }));
            
            // Re-apply sort just in case
            const tierValues = { "CHALLENGER": 90000, "GRANDMASTER": 80000, "MASTER": 70000, "DIAMOND": 60000, "EMERALD": 50000, "PLATINUM": 40000, "GOLD": 30000, "SILVER": 20000, "BRONZE": 10000, "IRON": 0, "UNRANKED": -10000 };
            const divValues = { "I": 1200, "II": 800, "III": 400, "IV": 0 };
            function getRankScore(rankStr) {
                if (!rankStr || rankStr === "Unranked") return -10000;
                let match = rankStr.toUpperCase().match(/^(\w+)(?:\s+([IVX]+))?\s+\((\d+)\s+LP\)/);
                if (!match) return 0;
                let tier = match[1]; let div = match[2] || ""; let lp = parseInt(match[3]);
                let score = (tierValues[tier] || 0);
                if (tier === "MASTER" || tier === "GRANDMASTER" || tier === "CHALLENGER") score += lp;
                else score += (divValues[div] || 0) + lp;
                return score;
            }
            players.sort((a, b) => getRankScore(b.Rank) - getRankScore(a.Rank));
            
            players.forEach(player => {
                if (!player.History || player.History.length === 0) return;
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                const header = document.createElement('div');
                header.className = 'player-card-header';
                header.textContent = `${player.name}#${player.Tag}`;
                playerCard.appendChild(header);
                
                const championsData = getChampionsData(player.History);
                const rolesData = getRolesData(player.History);
                const worstPingsGame = getWorstPingsGame(player.History);
                
                const chartsRow = document.createElement('div');
                chartsRow.className = 'charts-row';
                
                // Top Champions
                const champChartContainer = document.createElement('div');
                champChartContainer.className = 'chart-container';
                champChartContainer.innerHTML = `
                    <div class="chart-title">Top Champions</div>
                    <div class="pie-wrapper"><canvas id="champChart-${player.name}"></canvas></div>
                    <div id="legend-champ-${player.name}" class="custom-legend"></div>
                `;
                chartsRow.appendChild(champChartContainer);
                
                // Preferred Roles
                const rolesChartContainer = document.createElement('div');
                rolesChartContainer.className = 'chart-container';
                rolesChartContainer.innerHTML = `
                    <div class="chart-title">Preferred Roles</div>
                    <div class="pie-wrapper"><canvas id="rolesChart-${player.name}"></canvas></div>
                    <div id="legend-roles-${player.name}" class="custom-legend"></div>
                `;
                chartsRow.appendChild(rolesChartContainer);
                
                playerCard.appendChild(chartsRow);
                
                // Personal Worst
                if (worstPingsGame) {
                    const worstSection = document.createElement('div');
                    worstSection.className = 'personal-worst';
                    worstSection.onclick = () => openModal(player);
                    worstSection.innerHTML = `
                        <div class="personal-worst-title">Ping Record</div>
                        <div class="personal-worst-content">
                            <strong>${worstPingsGame.Champion}</strong> - ${worstPingsGame.totalPings} pings total
                            <div class="game-info">
                                ${worstPingsGame.dateStr} - <span class="result-${worstPingsGame.win ? 'win' : 'loss'}">${worstPingsGame.win ? 'VICTORY' : 'DEFEAT'}</span> - ${worstPingsGame.kda}
                            </div>
                            <div class="ping-breakdown">
                                ${worstPingsGame.breakdown.map(ping => 
                                    ping.count > 0 && ping.icon ? `
                                    <div class="ping-item">
                                        <img src="${ping.icon}" class="ping-icon" alt="${ping.name}">
                                        <div class="ping-type">${ping.name}</div>
                                        <div class="ping-count">${ping.count}</div>
                                    </div>` : ''
                                ).join('')}
                            </div>
                        </div>
                    `;
                    playerCard.appendChild(worstSection);
                }
                
                playerStatsGrid.appendChild(playerCard);
                
                createPieChart(`champChart-${player.name}`, `legend-champ-${player.name}`, championsData, 'champion');
                createPieChart(`rolesChart-${player.name}`, `legend-roles-${player.name}`, rolesData, 'role');
            });
            
            visualStatsContainer.style.display = 'block';
        }

        // --- CHARTS HELPERS ---
        function getChampionsData(history) {
            const champCounts = {};
            history.forEach(match => { champCounts[match.Champion] = (champCounts[match.Champion] || 0) + 1; });
            const sorted = Object.entries(champCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const labels = sorted.map(([champ]) => champ);
            const data = sorted.map(([, count]) => count);
            const top5Total = data.reduce((sum, val) => sum + val, 0);
            if (top5Total < history.length) { labels.push('Autres'); data.push(history.length - top5Total); }
            return { labels, data };
        }

        function getRolesData(history) {
            const roleCounts = {};
            history.forEach(match => {
                const role = match.Role === 'UTILITY' ? 'SUPPORT' : match.Role;
                if (role) roleCounts[role] = (roleCounts[role] || 0) + 1;
            });
            return { labels: Object.keys(roleCounts), data: Object.values(roleCounts) };
        }

        function getWorstPingsGame(history) {
            let worst = null;
            let maxPings = 0;
            history.forEach(match => {
                const totalPings = match.Pings || 0;
                if (totalPings > maxPings) { maxPings = totalPings; worst = match; }
            });
            if (!worst || maxPings === 0) return null;
            
            let dateStr = "-";
            if (worst.Date) {
                try { dateStr = new Date(worst.Date).toLocaleDateString('en-US', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); } catch (e) {}
            }
            
            const pingTypes = [
                { name: 'Missing', count: worst.EnemyMissingPings || 0, icon: 'img/ennemyMissing.png' },
                { name: 'Vision', count: worst.EnemyVisionPings || 0, icon: 'img/areaIsWarded.png' },
                { name: 'Need Vision', count: worst.NeedVisionPings || 0, icon: 'img/needVision.png' },
                { name: 'On My Way', count: worst.OnMyWayPings || 0, icon: 'img/onMyWay.png' },
                { name: 'Push', count: worst.PushPings || 0, icon: 'img/pushForward.png' },
                { name: 'Assist Me', count: worst.AssistMePings || 0, icon: 'img/assistMe.png' }
            ];
            
            return {
                Champion: worst.Champion, totalPings: maxPings, win: worst.Win, kda: worst.KDA, dateStr: dateStr,
                breakdown: pingTypes.filter(p => p.count > 0).sort((a, b) => b.count - a.count)
            };
        }

        function createPieChart(canvasId, legendId, chartData, type) {
            const ctx = document.getElementById(canvasId);
            const legendContainer = document.getElementById(legendId);
            if (!ctx || !legendContainer) return;

            const championIcons = {};
            const imagePromises = [];
            
            if (type === 'champion') {
                chartData.labels.forEach(champName => {
                    if (champName !== 'Autres') {
                        const img = new Image();
                        img.src = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/champion/${champName}.png`;
                        championIcons[champName] = img;
                        const promise = new Promise((resolve) => {
                            img.onload = () => resolve();
                            img.onerror = () => resolve();
                        });
                        imagePromises.push(promise);
                    }
                });
            }
            
            if (imagePromises.length > 0) {
                Promise.all(imagePromises).then(() => createChartAfterImagesLoaded());
            } else {
                createChartAfterImagesLoaded();
            }
            
            function createChartAfterImagesLoaded() {
                const roleColors = { 'TOP': '#4A5568', 'JUNGLE': '#2deb90', 'MIDDLE': '#7B2CBF', 'MID': '#7B2CBF', 'BOTTOM': '#ff5859', 'ADC': '#ff5859', 'SUPPORT': '#C8AA6E', 'UTILITY': '#C8AA6E' };
                const championColors = ['#C8AA6E', '#0AC8B9', '#4A5568', '#A09B8C', '#1E282D', '#3C3C41'];
                
                let chartColors;
                if (type === 'role') chartColors = chartData.labels.map(label => roleColors[label.toUpperCase()] || '#3C3C41');
                else chartColors = championColors;
                
                const championIconPlugin = {
                    id: 'championIconBackground',
                    beforeDraw: (chart) => {
                        if (type !== 'champion') return;
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(0);
                        meta.data.forEach((element, index) => {
                            const label = chart.data.labels[index];
                            if (label === 'Autres' || !championIcons[label]) return;
                            const img = championIcons[label];
                            const { x, y, startAngle, endAngle, outerRadius } = element;
                            const midAngle = (startAngle + endAngle) / 2;
                            const iconDistance = outerRadius * 0.6;
                            const iconX = x + Math.cos(midAngle) * iconDistance;
                            const iconY = y + Math.sin(midAngle) * iconDistance;
                            const iconSize = 40;
                            ctx.save();
                            ctx.globalAlpha = 0.3;
                            ctx.drawImage(img, iconX - iconSize / 2, iconY - iconSize / 2, iconSize, iconSize);
                            ctx.restore();
                        });
                    }
                };

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                            backgroundColor: chartColors,
                            borderColor: '#151a21',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(10, 10, 12, 0.95)',
                                titleColor: '#c8aa6e',
                                bodyColor: '#f0e6d2',
                                borderColor: '#333',
                                borderWidth: 1,
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return ` ${context.label}: ${context.parsed} games (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [championIconPlugin]
                });

                legendContainer.innerHTML = chartData.labels.map((label, index) => {
                    const color = Array.isArray(chartColors) ? chartColors[index % chartColors.length] : chartColors;
                    const value = chartData.data[index];
                    let iconHtml = '';
                    if (type === 'champion' && label !== 'Autres') iconHtml = `<img src="https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/champion/${label}.png" class="legend-icon" alt="${label}">`;
                    else iconHtml = `<div class="legend-color" style="background-color: ${color};"></div>`;
                    return `<div class="legend-item" title="${label}: ${value} games">${iconHtml}<span>${label}: ${value}</span></div>`;
                }).join('');
            }
        }

        // --- MODAL ---
        function openModal(player) {
            try {
                const modal = document.getElementById("myModal");
                document.getElementById("modalTitle").innerHTML = `History: <span style="color:#fff">${player.name}</span>`;
                const body = document.getElementById("modalBody");
                body.innerHTML = "";

                if (!player.History || player.History.length === 0) {
                    body.innerHTML = "<p>No matches found.</p>";
                } else {
                    const ul = document.createElement("ul");
                    ul.className = "match-history";
                    player.History.forEach((match, index) => {
                        const li = document.createElement("li");
                        li.className = "match-container";
                        const isWin = match.Win;
                        const resultClass = isWin ? 'match-win' : 'match-loss';
                        const resultText = isWin ? "VICTORY" : "DEFEAT";
                        // Simple modal content for now
                        li.innerHTML = `<div class="match-row ${resultClass}"><span>${match.Champion}</span><span>${resultText}</span><span>${match.KDA}</span></div>`; 
                        ul.appendChild(li);
                    });
                    body.appendChild(ul);
                }
                modal.style.display = "block";
            } catch (err) { console.error(err); }
        }
        function closeModal() { document.getElementById("myModal").style.display = "none"; }
        window.onclick = function(e) { if (e.target == document.getElementById("myModal")) closeModal(); }
    </script>
</body>
</html>